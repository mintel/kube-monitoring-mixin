---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    app.kubernetes.io/managed-by: kustomize
    app.mintel.com/env: qa
    app.mintel.com/region: eu-west
  labels:
    app.kubernetes.io/name: redisoperator
    app.kubernetes.io/part-of: redisoperator
    app.mintel.com/owner: sre
    prometheus: k8s
    role: alert-rules
  name: redis.rules
  namespace: kube-operators
spec:
  groups:
  - name: mintel-apiserver.rules
    rules:
    - alert: RedisReplicationFallingBehind
      annotations:
        description: The Redis slave {{ $labels.pod }} is {{ $value }} seconds behind
          the master
        summary: Redis slave replication falling behind.
      expr: redis_connected_slave_lag_seconds{} >= 5
      for: 5m
      labels:
        severity: warning
    - alert: RedisReplicationFallingBehind
      annotations:
        description: The Redis slave {{ $labels.pod }} is {{ $value }} seconds behind
          the master
        summary: Redis slave replication falling behind.
      expr: redis_connected_slave_lag_seconds{} >= 30
      for: 30m
      labels:
        severity: critical
    - alert: RedisSlaveDown
      annotations:
        description: '{{ $value }} slaves are down in Redis cluster {{ $labels.service
          }}'
        summary: One or more Redis slaves are down.
      expr: ( count by (service,app_mintel_com_owner) (redis_connected_slaves) - 1
        ) - sum by (service,app_mintel_com_owner) (redis_connected_slaves) != 0
      for: 5m
      labels:
        severity: warning
    - alert: RedisSlaveDown
      annotations:
        description: all slaves are down in Redis cluster {{ $labels.service }}
        summary: all Redis slaves are down.
      expr: sum by (service,app_mintel_com_owner) (redis_connected_slaves) == 0
      for: 5m
      labels:
        severity: critical
    - alert: RedisMemoryUtilHigh
      annotations:
        description: The {{ $labels.service }} Redis cluster has consumed >90% of
          its available memory
        summary: Redis Memory utilization high
      expr: (redis_memory_used_bytes / redis_memory_max_bytes  * 100 > 90 ) < 101
      for: 5m
      labels:
        page: "false"
        severity: critical
    - alert: RedisMaxMemoryUnset
      annotations:
        description: The redis instance {{ $labels.alias }} has no maximum memory
          set.
        summary: Redis instance has non max-memory set
      expr: redis_memory_max_bytes <= 0
      for: 5m
      labels:
        severity: warning
    - alert: RedisRejectedConnections
      annotations:
        description: Some connections to Redis have been rejected each minute for
          the previous 10 minutes.
        summary: Rejected connections (instance {{ $labels.alias }}).
      expr: increase(redis_rejected_connections_total[1m]) > 0
      for: 10m
      labels:
        severity: warning
    - alert: RedisOperatorClusterNotOK
      annotations:
        description: The Redis operator has detected an error with a cluster.
        summary: The Redis operator has detected that the {{ $labels.name }} cluster
          is not ok.
      expr: redis_operator_controller_cluster_ok == 0
      for: 5m
      labels:
        severity: critical
    - alert: RedisOperatorRequeue
      annotations:
        description: The Redis operator is requeueing events at a high rate
        summary: The Redis operator is requeueing events at a high rate.  This is
          usually indicative of an error in its reconciliation loop.
      expr: increase(kooper_controller_queued_events_total{type="requeue"}[5m]) >
        5
      for: 5m
      labels:
        severity: warning
    - alert: RedisOperatorErrors
      annotations:
        description: The Redis operator is experiencing errors
        summary: The Redis operator is experiencing errors.
      expr: increase(kooper_controller_processed_event_errors_total[5m]) > 5
      for: 5m
      labels:
        severity: warning
